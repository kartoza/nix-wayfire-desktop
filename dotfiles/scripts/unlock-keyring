#!/usr/bin/env bash

# Script to unlock GNOME Keyring at Hyprland login
# This ensures the keyring is available for GPG key passphrases
# NOTE: SSH authentication is handled by GPG agent, not keyring

# Wait a moment for desktop to be ready
sleep 2

# Check if gnome-keyring-daemon is already running
if pgrep -f gnome-keyring-daemon >/dev/null; then
  echo "GNOME Keyring daemon is already running"

  # Check if the default keyring is unlocked
  if ! secret-tool lookup service test 2>/dev/null; then
    echo "Keyring appears to be locked, attempting to unlock..."

    # Use zenity to prompt for password to unlock keyring
    password=$(zenity --password --title="Unlock Keyring" --text="Enter your password to unlock GNOME Keyring\n\nThis will allow GPG and SSH to work without repeated password prompts.")

    if [ -n "$password" ]; then
      # Attempt to unlock keyring
      echo -n "$password" | gnome-keyring-daemon --unlock

      if [ $? -eq 0 ]; then
        notify-send "Keyring Unlocked" "GPG and SSH keys are now available"

        # Connect GPG agent to the unlocked keyring
        export GPG_TTY=$(tty)
        gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

        echo "GPG agent connected to unlocked keyring"
      else
        notify-send "Keyring Unlock Failed" "Incorrect password or keyring error"
      fi
    else
      notify-send "Keyring Unlock Cancelled" "You'll be prompted for passphrases when using GPG/SSH"
    fi
  else
    echo "Keyring is already unlocked"

    # Ensure GPG agent is connected
    export GPG_TTY=$(tty)
    gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

    notify-send "Keyring Ready" "GPG and SSH keys are available"
  fi
else
  echo "GNOME Keyring daemon not running, starting it now..."

  # Use zenity to prompt for password to start and unlock keyring
  password=$(zenity --password --title="Unlock Keyring" --text="Enter your password to unlock GNOME Keyring\n\nThis will allow GPG and SSH to work without repeated password prompts.")

  if [ -n "$password" ]; then
    # Start gnome-keyring-daemon WITHOUT ssh component (GPG agent handles SSH)
    eval $(echo -n "$password" | gnome-keyring-daemon --start --components=pkcs11,secrets)

    if [ $? -eq 0 ]; then
      # Export the environment variables for this session
      if [ -n "$GNOME_KEYRING_CONTROL" ]; then
        systemctl --user set-environment GNOME_KEYRING_CONTROL="$GNOME_KEYRING_CONTROL"
      fi

      notify-send "Keyring Started" "GNOME Keyring has been started and unlocked"

      # Connect GPG agent to keyring
      export GPG_TTY=$(tty)
      gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

      echo "GPG agent connected to unlocked keyring"
    else
      notify-send "Keyring Error" "Failed to start GNOME Keyring daemon"
    fi
  else
    notify-send "Keyring Cancelled" "You'll be prompted for passphrases when using GPG/SSH"
  fi
fi
