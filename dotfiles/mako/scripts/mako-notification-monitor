#!/usr/bin/env bash
#
# Monitor and display notifications as they are sent to mako.
# Shows the exact text and markup that mako will receive and render.
#

echo "Mako Notification Monitor"
echo "======================================================================"
echo "Monitoring notifications sent to mako..."
echo "Press Ctrl+C to exit"
echo ""

# Use dbus-monitor to catch all notifications
dbus-monitor "interface='org.freedesktop.Notifications',member='Notify'" 2>/dev/null | \
awk '
BEGIN {
    capturing = 0
}

/method call.*Notify/ {
    timestamp = strftime("%H:%M:%S")
    capturing = 1
    stage = 0  # 0=app, 1=icon, 2=summary, 3=body, 4=actions, 5=hints
    app_name = ""
    icon = ""
    summary = ""
    body = ""
    actions = ""
    in_array = 0
    next
}

# Track when we enter/exit arrays and dicts
capturing && /array \[/ {
    if (stage == 3) stage = 4  # entering actions array
    else if (stage == 4) stage = 5  # entering hints array
    in_array++
    next
}

capturing && /\]/ {
    in_array--
    if (in_array == 0 && stage == 4) {
        stage = 5  # finished actions, now in hints
    }
    next
}

# Capture string values based on stage (flexible whitespace)
capturing && /string "/ {
    match($0, /string "(.*)"/, arr)
    value = arr[1]

    if (stage == 0) {
        app_name = value
        stage = 1
    }
    else if (stage == 1) {
        icon = value
        stage = 2
    }
    else if (stage == 2) {
        summary = value
        stage = 3
    }
    else if (stage == 3 && in_array == 0) {
        body = value
        # Dont advance stage, wait for actions array
    }
    else if (stage == 4 && in_array > 0) {
        # Action ID or label inside actions array
        if (actions != "") actions = actions ", "
        actions = actions "\"" value "\""
    }
    next
}

# Skip uint32 lines
capturing && /uint32/ {
    next
}

# Detect the final int32 timeout, which signals end of notification
capturing && /int32/ {
    # Print the notification
    print ""
    print "======================================================================"
    print "[" timestamp "] NOTIFICATION"
    print "======================================================================"
    if (app_name != "") print "App:     " app_name
    if (icon != "") print "Icon:    " icon
    print ""
    print "Summary: " summary
    if (body != "") {
        print ""
        print "Body:"
        # Handle newline escapes
        gsub(/\\n/, "\n  ", body)
        print "  " body
    }
    if (actions != "") {
        print ""
        print "Actions: [" actions "]"
    }
    print "======================================================================"
    fflush()

    # Reset for next notification
    capturing = 0
    next
}
'
