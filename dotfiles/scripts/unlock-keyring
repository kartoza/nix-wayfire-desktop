#!/usr/bin/env bash

# Script to unlock GNOME Keyring at Hyprland login
# This ensures the keyring is available for SSH keys and other secrets

# Check if gnome-keyring-daemon is already running
if pgrep -f gnome-keyring-daemon >/dev/null; then
  echo "GNOME Keyring daemon is already running"

  # Check if the default keyring is unlocked
  if ! secret-tool lookup service test 2>/dev/null; then
    echo "Keyring appears to be locked, attempting to unlock..."

    # Use zenity to prompt for password to unlock keyring
    password=$(zenity --password --title="Unlock Keyring" --text="Please enter your password to unlock the keyring:")

    if [ -n "$password" ]; then
      # Attempt to unlock keyring
      echo -n "$password" | gnome-keyring-daemon --unlock --daemonize

      if [ $? -eq 0 ]; then
        notify-send "Keyring Unlocked" "Your keyring has been successfully unlocked"

        # Start GPG agent and connect to keyring
        export GPG_TTY=$(tty)
        gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

        # Test GPG functionality
        if gpg --list-secret-keys >/dev/null 2>&1; then
          echo "GPG keys are now accessible"
        fi
      else
        notify-send "Keyring Unlock Failed" "Failed to unlock keyring with provided password"
      fi
    else
      notify-send "Keyring Unlock Cancelled" "Keyring unlock was cancelled"
    fi
  else
    echo "Keyring is already unlocked"

    # Ensure GPG agent is connected
    export GPG_TTY=$(tty)
    gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

    notify-send "Keyring Ready" "Your keyring is already unlocked and ready"
  fi
else
  echo "GNOME Keyring daemon not running, starting it now..."

  # Use zenity to prompt for password to start and unlock keyring
  password=$(zenity --password --title="Unlock Keyring" --text="Please enter your password to unlock the keyring:")

  if [ -n "$password" ]; then
    # Start gnome-keyring-daemon with all components
    eval $(echo -n "$password" | gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)

    if [ $? -eq 0 ]; then
      # Export the environment variables for this session
      export $(echo -n "$password" | gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)

      notify-send "Keyring Started" "GNOME Keyring daemon has been started and unlocked"

      # Start GPG agent and connect to keyring
      export GPG_TTY=$(tty)
      gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1

      # Test GPG functionality
      if gpg --list-secret-keys >/dev/null 2>&1; then
        echo "GPG keys are now accessible"
      fi
    else
      notify-send "Keyring Error" "Failed to start GNOME Keyring daemon"
    fi
  else
    notify-send "Keyring Cancelled" "Keyring unlock was cancelled"
  fi
fi
