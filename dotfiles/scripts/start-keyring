#!/usr/bin/env bash

# Script to start GNOME Keyring daemon at Hyprland session start
# This ensures the daemon is running and environment variables are set
# NOTE: We only start pkcs11,secrets components (NOT ssh)
# SSH authentication is handled by GPG agent with enableSSHSupport

# Check if gnome-keyring-daemon is already running
if pgrep -f gnome-keyring-daemon >/dev/null; then
  echo "GNOME Keyring daemon is already running"
else
  echo "Starting GNOME Keyring daemon..."

  # Start gnome-keyring-daemon WITHOUT ssh component
  # The --start flag outputs shell commands to set environment variables
  eval $(gnome-keyring-daemon --start --components=pkcs11,secrets 2>/dev/null)

  if [ -n "$GNOME_KEYRING_CONTROL" ]; then
    systemctl --user set-environment GNOME_KEYRING_CONTROL="$GNOME_KEYRING_CONTROL"
  fi

  echo "GNOME Keyring daemon started successfully (secrets only)"
fi

# Set SSH agent to GPG agent socket
# GPG agent is configured with enableSSHSupport and will handle SSH authentication
USER_ID=$(id -u)
GPG_SSH_SOCKET="/run/user/${USER_ID}/gnupg/S.gpg-agent.ssh"

if [ -S "$GPG_SSH_SOCKET" ]; then
  export SSH_AUTH_SOCK="$GPG_SSH_SOCKET"
  systemctl --user set-environment SSH_AUTH_SOCK="$GPG_SSH_SOCKET"
  dbus-update-activation-environment --systemd SSH_AUTH_SOCK 2>/dev/null
  echo "SSH agent socket set to GPG agent: $GPG_SSH_SOCKET"
else
  echo "Warning: GPG agent SSH socket not found at $GPG_SSH_SOCKET"
  echo "SSH authentication may not work until GPG agent starts"
fi
